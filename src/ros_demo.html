<html>
<head>
<style type="text/css">
#prob_output>div {
	display: inline-block;
	width: 240px;
	margin: 0 8px;

	font-size: 150%;
}
#prob_output>div>div {
	background: #39F;
	height: 30px;
}
#prob_output>div>div.conf {
	background: #F93;
}
#prob_output>div>span {
	display:block;
	width: 100%;
}
#layout tr:first-child td {
	height: 480px;
}
</style>
</head>
<body>
<table cellspacing="2" cellpadding="0" id="layout">
<tr>
	<td><video src="http://localhost:8888/streams/openni/rgb/image_color.webm?enc=webm&bitrate=100000&framerate=31" autoplay="true" preload="none" ></video></td>
	<td><img id="face" src="confused.jpg" style="height: 480px; margin: 0 0 0 -15%" /></td>
</tr>
<tr>
	<td colspan="2"><div id="prob_output"></div></td>
</tr>

</body>
<script type="text/javascript" src="eventemitter2.min.js"></script>
<script type="text/javascript" src="roslib.min.js"></script>
<script type="text/javascript">
	function $(v){return document.getElementById(v);}
	console.log("Connecting to ROS");
	var ros = new ROSLIB.Ros({
		url : 'ws://localhost:9090'
	});
	ros.on('connection', function() {
		console.log('Connected to websocket server.');
	});

	ros.on('error', function(error) {
		console.log('Error connecting to websocket server: ', error);
	});
	ros.on('close', function() {
		console.log('Connection to websocket server closed.');
	});
	
	var gesture_topic = new ROSLIB.Topic({
		ros : ros,
		name : 'ros_gesture_demo',
		messageType : 'std_msgs/String'
	});

var rec_objects = {};
var rec_objects_count = 0;
var rec_objects_prob = [];
var rec_objects_node = [];
var rec_objects_name = [];

	gesture_topic.subscribe(function(message) {
		//console.log('Received message on ' + gesture_topic.name + ': ' + message.data);
		var tmp = message.data.split(";");
		var confident = 0; // Number of items at confidence level > 0.70;
		for (var i = 0; i < tmp.length; ++i) {
			var entry = tmp[i].split(":");
			//console.log(entry);
			//$(entry[0] + "_val").innerHtml = entry[1];
			// If the object has not already been recognized, add it to the pool:			
			if(!(entry[0] in rec_objects)){
				// Initialize the new object-to-index lookup:
				rec_objects[entry[0]] = rec_objects_count;
				// Assign it a name:
				rec_objects_name[rec_objects_count] = entry[0];					
				// Create a new node for it in the DOM, and then append it to div#prob_output:
				rec_objects_node[rec_objects_count] = document.createElement("div");
				rec_objects_node[rec_objects_count].innerHTML = "&nbsp;";				
				rec_objects_node[rec_objects_count].className = "histbar";
				var docFrag = document.createElement("div");
				var textFrag = document.createElement("span");
				textFrag.innerText = rec_objects_name[rec_objects_count];
				docFrag.appendChild(textFrag);
				docFrag.appendChild(rec_objects_node[rec_objects_count]);
				$("prob_output").appendChild(docFrag);
				// Move to the next index:
				rec_objects_count++;
			}
			var c = parseFloat(entry[1]); // Parse the confidence level
			rec_objects_prob[rec_objects[entry[0]]] = c;
			if (c > 0.70) {
				confident++;
			}
		}

		$("face").src = (confident == 1)?"happy.jpg":"confused.jpg";
		updateDisplay();
	});
	
	// Update the display based on the contents of rec_objects:`
	function updateDisplay(){
		for (var i = 0; i < rec_objects_count; ++i){
			rec_objects_node[i].style.width = Math.round(200*rec_objects_prob[i]) + "px";
			rec_objects_node[i].className = (rec_objects_prob[i]>0.70)?"conf":"";
		}
	}

	/*
	setInterval(function(){
		$("face").src = ($("face").getAttribute("src") == "confused.jpg")?"happy.jpg":"confused.jpg";
	}, 1000);
	*/
</script>
</html>
